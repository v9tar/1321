-- Ultimate Fruit Trade Controller v15.0 FINAL
-- السكربت الكامل مع جميع الإصلاحات

local Player = game:GetService("Players").LocalPlayer
local UIS = game:GetService("UserInputService")
local TS = game:GetService("TweenService")
local RS = game:GetService("RunService")
local HS = game:GetService("HttpService")

--[[ نظام الحماية المتقدم ]]
local function SecureFunction(func)
    return function(...)
        local args = {...}
        local success, result = pcall(function()
            return func(unpack(args))
        end)
        if not success then
            warn("خطأ في التنفيذ:", result)
        end
        return success, result
    end
end

--[[ إنشاء الواجهة ]]
local GUI = Instance.new("ScreenGui")
GUI.Name = "TradeController_"..HS:GenerateGUID(false)
GUI.ResetOnSpawn = false
GUI.Parent = game:GetService("CoreGui")

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 320, 0, 220)
MainFrame.Position = UDim2.new(0.5, -160, 0.5, -110)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.Active = true
MainFrame.Parent = GUI

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

-- شريط العنوان
local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 30)
TitleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
TitleBar.Parent = MainFrame

local TitleText = Instance.new("TextLabel")
TitleText.Text = " تحكم التداول v15.0"
TitleText.TextColor3 = Color3.fromRGB(220, 220, 220)
TitleText.TextXAlignment = Enum.TextXAlignment.Left
TitleText.Size = UDim2.new(0.7, 0, 1, 0)
TitleText.Position = UDim2.new(0.05, 0, 0, 0)
TitleText.Font = Enum.Font.GothamBold
TitleText.Parent = TitleBar

-- إطار المحتوى
local ContentFrame = Instance.new("Frame")
ContentFrame.Size = UDim2.new(1, -20, 1, -50)
ContentFrame.Position = UDim2.new(0, 10, 0, 40)
ContentFrame.BackgroundTransparency = 1
ContentFrame.Parent = MainFrame

-- عناصر التحكم
local PlayerBox = Instance.new("TextBox")
PlayerBox.PlaceholderText = "اسم اللاعب (2+ أحرف)"
PlayerBox.Size = UDim2.new(1, 0, 0, 30)
PlayerBox.Position = UDim2.new(0, 0, 0, 10)
PlayerBox.ClearTextOnFocus = false
PlayerBox.Parent = ContentFrame

local ControlBtn = Instance.new("TextButton")
ControlBtn.Text = "بدء التحكم"
ControlBtn.Size = UDim2.new(1, 0, 0, 35)
ControlBtn.Position = UDim2.new(0, 0, 0, 50)
ControlBtn.Parent = ContentFrame

local JumpToggle = Instance.new("TextButton")
JumpToggle.Text = "تعطيل القفز (له)"
JumpToggle.Size = UDim2.new(0.48, 0, 0, 35)
JumpToggle.Position = UDim2.new(0, 0, 0, 95)
JumpToggle.Parent = ContentFrame

local SelfJumpToggle = Instance.new("TextButton")
SelfJumpToggle.Text = "تعطيل القفز (لي)"
SelfJumpToggle.Size = UDim2.new(0.48, 0, 0, 35)
SelfJumpToggle.Position = UDim2.new(0.52, 0, 0, 95)
SelfJumpToggle.Parent = ContentFrame

local AcceptBtn = Instance.new("TextButton")
AcceptBtn.Text = "قبول التداول"
AcceptBtn.Size = UDim2.new(1, 0, 0, 35)
AcceptBtn.Position = UDim2.new(0, 0, 0, 140)
AcceptBtn.Parent = ContentFrame

--[[ الأنظمة الأساسية ]]
local ControlledPlayer = nil
local Debounce = false

local function FindPlayer(name)
    name = name:lower():gsub("[%c%z]", ""):sub(1, 20)
    if #name < 2 then return nil end
    
    local closestPlayer, minDiff = nil, math.huge
    
    for _, player in pairs(game:GetService("Players"):GetPlayers()) do
        if player ~= Player then
            local playerName = player.Name:lower()
            local diff = math.abs(#playerName - #name)
            
            if playerName:find(name) and diff < minDiff then
                closestPlayer = player
                minDiff = diff
            end
        end
    end
    
    return closestPlayer
end

local ControlSystem = {
    ToggleJump = SecureFunction(function(target, state)
        if not target or not target.Character then return false end
        
        local humanoid = target.Character:FindFirstChildOfClass("Humanoid")
        if not humanoid then return false end
        
        if state then
            humanoid:SetAttribute("OriginalJump", humanoid.JumpPower)
            humanoid.JumpPower = 0
        else
            humanoid.JumpPower = humanoid:GetAttribute("OriginalJump") or 50
        end
        
        return true
    end),
    
    ForceAccept = SecureFunction(function()
        local found = false
        for _, button in pairs(game:GetService("CoreGui"):GetDescendants()) do
            if button:IsA("TextButton") and button.Text:lower():match("^accept") then
                for _, v in pairs(getconnections(button.MouseButton1Click)) do
                    v:Fire()
                    found = true
                end
            end
        end
        return found
    end)
}

--[[ نظام السحب ]]
local dragging, dragStart, frameStart = false, nil, nil

UIS.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        local mousePos = input.Position
        local absPos = MainFrame.AbsolutePosition
        local absSize = MainFrame.AbsoluteSize
        
        if mousePos.X >= absPos.X and mousePos.X <= absPos.X + absSize.X and
           mousePos.Y >= absPos.Y and mousePos.Y <= absPos.Y + absSize.Y then
           
            local clickedOnElement = false
            for _, child in ipairs(MainFrame:GetDescendants()) do
                if child:IsA("GuiButton") or child:IsA("TextBox") then
                    local childPos = child.AbsolutePosition
                    local childSize = child.AbsoluteSize
                    if mousePos.X >= childPos.X and mousePos.X <= childPos.X + childSize.X and
                       mousePos.Y >= childPos.Y and mousePos.Y <= childPos.Y + childSize.Y then
                        clickedOnElement = true
                        break
                    end
                end
            end
            
            if not clickedOnElement then
                dragging = true
                dragStart = mousePos
                frameStart = MainFrame.Position
                
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then
                        dragging = false
                    end
                end)
            end
        end
    end
end)

UIS.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(
            frameStart.X.Scale,
            frameStart.X.Offset + delta.X,
            frameStart.Y.Scale,
            frameStart.Y.Offset + delta.Y
        )
    end
end)

--[[ توصيل الأحداث ]]
ControlBtn.MouseButton1Click:Connect(function()
    if Debounce then return end
    Debounce = true
    
    local target = FindPlayer(PlayerBox.Text)
    if target then
        ControlledPlayer = target
        PlayerBox.Text = target.Name
        ControlBtn.Text = "التحكم: "..target.Name
    else
        warn("لم يتم العثور على اللاعب")
    end
    
    Debounce = false
end)

JumpToggle.MouseButton1Click:Connect(function()
    if not ControlledPlayer then return end
    
    local newState = JumpToggle.Text == "تعطيل القفز (له)"
    local success = ControlSystem.ToggleJump(ControlledPlayer, newState)
    
    if success then
        JumpToggle.Text = newState and "تمكين القفز (له)" or "تعطيل القفز (له)"
    else
        warn("فشل في التحكم بقفز اللاعب")
    end
end)

SelfJumpToggle.MouseButton1Click:Connect(function()
    local newState = SelfJumpToggle.Text == "تعطيل القفز (لي)"
    local success = ControlSystem.ToggleJump(Player, newState)
    
    if success then
        SelfJumpToggle.Text = newState and "تمكين القفز (لي)" or "تعطيل القفز (لي)"
    else
        warn("فشل في التحكم بقفزك")
    end
end)

AcceptBtn.MouseButton1Click:Connect(function()
    local success = ControlSystem.ForceAccept()
    if not success then
        warn("تأكد من فتح نافذة التداول أولاً!")
    end
end)

-- حماية ضد الحذف
RS.Heartbeat:Connect(function()
    if not GUI or not GUI.Parent then
        GUI = GUI:Clone()
        GUI.Parent = game:GetService("CoreGui")
    end
end)

warn("تم تحميل سكربت التحكم بنجاح!")
